From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Kuan-Chih Wang <kuanchihwang@outlook.com>
Date: Thu, 5 Feb 2026 08:15:44 +0800
Subject: [PATCH] Fix feature detection logic for MPI-related capabilities

The `FindMPI` CMake module already sets `MPI_Fortran_HAVE_F77_HEADER` and
`MPI_Fortran_HAVE_F90_MODULE`. Just use them and stop improvising broken ways
to attempt the same thing but unsuccessfully.
---
 src/flib/CMakeLists.txt | 25 ++++++-------------------
 src/gptl/CMakeLists.txt | 10 +---------
 2 files changed, 7 insertions(+), 28 deletions(-)

diff --git a/src/flib/CMakeLists.txt b/src/flib/CMakeLists.txt
index bc909f45..26ee4dfa 100644
--- a/src/flib/CMakeLists.txt
+++ b/src/flib/CMakeLists.txt
@@ -170,18 +170,13 @@ if (PIO_USE_MPISERIAL)
   endif ()
 endif ()
 
-# Check MPI I/O capabilities
-find_path(MPIF_H_PATH
-  NAMES mpif.h
-  PATHS ${MPI_Fortran_INCLUDE_PATH}
-  NO_DEFAULT_PATH)
-if (MPIF_H_PATH)
+# Check for MPI I/O capabilities
+if (MPI_Fortran_HAVE_F77_HEADER)
   check_macro (MPI_HAS_MPIIO
     NAME TryMPIIO.f90
     HINTS ${CMAKE_MODULE_PATH}
-    DEFINITIONS -I${MPIF_H_PATH}
     COMMENT "whether MPIIO is supported")
-  if (${MPI_HAS_MPIIO})
+  if (MPI_HAS_MPIIO)
     message (STATUS "MPIIO verified and enabled.")
     target_compile_definitions (piof
       PUBLIC USEMPIIO)
@@ -193,16 +188,7 @@ else ()
 endif ()
 
 # Check for MPI Fortran module
-find_path(MPIMOD_PATH
-  NAMES mpi.mod MPI.mod
-  HINTS ${MPI_Fortran_INCLUDE_PATH})
-
-check_macro (MPI_HAS_Fortran_MOD
-  NAME TryMPIMod.f90
-  HINTS ${CMAKE_MODULE_PATH}
-  DEFINITIONS -I${MPIMOD_PATH}
-  COMMENT "whether MPI Fortran module is supported")
-if (${MPI_HAS_Fortran_MOD})
+if (MPI_Fortran_HAVE_F90_MODULE)
   message (STATUS "MPI Fortran module verified and enabled.")
 else ()
   message (STATUS "MPI Fortran module failed verification and therefore disabled.")
@@ -210,7 +196,8 @@ else ()
     target_compile_definitions (gptl
       PUBLIC NO_MPIMOD)
   endif()
-  target_compile_definitions (piof PUBLIC NO_MPIMOD)
+  target_compile_definitions (piof
+    PUBLIC NO_MPIMOD)
 endif ()
 
 #===== GPTL =====
diff --git a/src/gptl/CMakeLists.txt b/src/gptl/CMakeLists.txt
index ac9c1cfd..c018afd8 100644
--- a/src/gptl/CMakeLists.txt
+++ b/src/gptl/CMakeLists.txt
@@ -134,15 +134,7 @@ if (NOT MPI_HAS_COMM_F2C)
 endif ()
 
 # Check for MPI Fortran module
-find_path(MPIMOD_PATH
-  NAMES mpi.mod MPI.mod
-  PATHS ${MPI_Fortran_INCLUDE_PATH})
-check_macro (MPI_HAS_Fortran_MOD
-  NAME TryMPIMod.f90
-  HINTS ${CMAKE_MODULE_PATH}
-  DEFINITIONS -I${MPIMOD_PATH}
-  COMMENT "whether MPI Fortran module is supported")
-if (${MPI_HAS_Fortran_MOD})
+if (MPI_Fortran_HAVE_F90_MODULE)
   message (STATUS "MPI Fortran module verified and enabled.")
 else ()
   message (STATUS "MPI Fortran module failed verification and therefore disabled.")
-- 
2.47.3

